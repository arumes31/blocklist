package api

import (
	"net/http"
	"net/http/httptest"
	"testing"

	"blocklist/internal/config"
	"blocklist/internal/repository"
	"blocklist/internal/service"
	"github.com/alicebob/miniredis/v2"
	"github.com/gin-contrib/sessions"
	"github.com/gin-contrib/sessions/cookie"
	"github.com/gin-gonic/gin"
)

func TestPentest_RBAC_Escalation(t *testing.T) {
	mr, _ := miniredis.Run()
	defer mr.Close()

	rRepo := repository.NewRedisRepository(mr.Host(), mr.Port(), 0)
	gin.SetMode(gin.TestMode)
	router := gin.New()
	store := cookie.NewStore([]byte("secret"))
	router.Use(sessions.Sessions("blocklist_session", store))

	cfg := &config.Config{GUIAdmin: "admin"}
	ipSvc := service.NewIPService(cfg, rRepo, nil)
	h := NewAPIHandler(cfg, rRepo, nil, nil, ipSvc, nil, nil)

	// Mock VIEWER session
	router.Use(func(c *gin.Context) {
		session := sessions.Default(c)
		session.Set("logged_in", true)
		session.Set("username", "viewer_user")
		session.Set("role", "viewer")
		session.Set("client_ip", "127.0.0.1")
		_ = session.Save()
		c.Next()
	})

	router.POST("/block", h.RBACMiddleware("operator"), h.BlockIP)

	// Attempt to block as viewer (should fail)
	req, _ := http.NewRequest("POST", "/block", nil)
	req.Header.Set("Origin", "http://localhost")
	w := httptest.NewRecorder()
	router.ServeHTTP(w, req)

	if w.Code != http.StatusForbidden {
		t.Errorf("Security flaw: Viewer could access operator route! Expected 403, got %d", w.Code)
	}
}

func TestPentest_CSRF_Bypass(t *testing.T) {
	// Our app checks Origin/Referer in main.go middleware
	// We can test that logic by creating a router with that middleware
}
